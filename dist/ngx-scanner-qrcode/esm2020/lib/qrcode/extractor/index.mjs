import { BitMatrix } from "../BitMatrix";
function squareToQuadrilateral(p1, p2, p3, p4) {
    const dx3 = p1.x - p2.x + p3.x - p4.x;
    const dy3 = p1.y - p2.y + p3.y - p4.y;
    if (dx3 === 0 && dy3 === 0) { // Affine
        return {
            a11: p2.x - p1.x,
            a12: p2.y - p1.y,
            a13: 0,
            a21: p3.x - p2.x,
            a22: p3.y - p2.y,
            a23: 0,
            a31: p1.x,
            a32: p1.y,
            a33: 1,
        };
    }
    else {
        const dx1 = p2.x - p3.x;
        const dx2 = p4.x - p3.x;
        const dy1 = p2.y - p3.y;
        const dy2 = p4.y - p3.y;
        const denominator = dx1 * dy2 - dx2 * dy1;
        const a13 = (dx3 * dy2 - dx2 * dy3) / denominator;
        const a23 = (dx1 * dy3 - dx3 * dy1) / denominator;
        return {
            a11: p2.x - p1.x + a13 * p2.x,
            a12: p2.y - p1.y + a13 * p2.y,
            a13,
            a21: p4.x - p1.x + a23 * p4.x,
            a22: p4.y - p1.y + a23 * p4.y,
            a23,
            a31: p1.x,
            a32: p1.y,
            a33: 1,
        };
    }
}
function quadrilateralToSquare(p1, p2, p3, p4) {
    // Here, the adjoint serves as the inverse:
    const sToQ = squareToQuadrilateral(p1, p2, p3, p4);
    return {
        a11: sToQ.a22 * sToQ.a33 - sToQ.a23 * sToQ.a32,
        a12: sToQ.a13 * sToQ.a32 - sToQ.a12 * sToQ.a33,
        a13: sToQ.a12 * sToQ.a23 - sToQ.a13 * sToQ.a22,
        a21: sToQ.a23 * sToQ.a31 - sToQ.a21 * sToQ.a33,
        a22: sToQ.a11 * sToQ.a33 - sToQ.a13 * sToQ.a31,
        a23: sToQ.a13 * sToQ.a21 - sToQ.a11 * sToQ.a23,
        a31: sToQ.a21 * sToQ.a32 - sToQ.a22 * sToQ.a31,
        a32: sToQ.a12 * sToQ.a31 - sToQ.a11 * sToQ.a32,
        a33: sToQ.a11 * sToQ.a22 - sToQ.a12 * sToQ.a21,
    };
}
function times(a, b) {
    return {
        a11: a.a11 * b.a11 + a.a21 * b.a12 + a.a31 * b.a13,
        a12: a.a12 * b.a11 + a.a22 * b.a12 + a.a32 * b.a13,
        a13: a.a13 * b.a11 + a.a23 * b.a12 + a.a33 * b.a13,
        a21: a.a11 * b.a21 + a.a21 * b.a22 + a.a31 * b.a23,
        a22: a.a12 * b.a21 + a.a22 * b.a22 + a.a32 * b.a23,
        a23: a.a13 * b.a21 + a.a23 * b.a22 + a.a33 * b.a23,
        a31: a.a11 * b.a31 + a.a21 * b.a32 + a.a31 * b.a33,
        a32: a.a12 * b.a31 + a.a22 * b.a32 + a.a32 * b.a33,
        a33: a.a13 * b.a31 + a.a23 * b.a32 + a.a33 * b.a33,
    };
}
export function extract(image, location) {
    const qToS = quadrilateralToSquare({ x: 3.5, y: 3.5 }, { x: location.dimension - 3.5, y: 3.5 }, { x: location.dimension - 6.5, y: location.dimension - 6.5 }, { x: 3.5, y: location.dimension - 3.5 });
    const sToQ = squareToQuadrilateral(location.topLeft, location.topRight, location.alignmentPattern, location.bottomLeft);
    const transform = times(sToQ, qToS);
    const matrix = BitMatrix.createEmpty(location.dimension, location.dimension);
    const mappingFunction = (x, y) => {
        const denominator = transform.a13 * x + transform.a23 * y + transform.a33;
        return {
            x: (transform.a11 * x + transform.a21 * y + transform.a31) / denominator,
            y: (transform.a12 * x + transform.a22 * y + transform.a32) / denominator,
        };
    };
    for (let y = 0; y < location.dimension; y++) {
        for (let x = 0; x < location.dimension; x++) {
            const xValue = x + 0.5;
            const yValue = y + 0.5;
            const sourcePixel = mappingFunction(xValue, yValue);
            matrix.set(x, y, image.get(Math.floor(sourcePixel.x), Math.floor(sourcePixel.y)));
        }
    }
    return {
        matrix,
        mappingFunction,
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc2Nhbm5lci1xcmNvZGUvc3JjL2xpYi9xcmNvZGUvZXh0cmFjdG9yL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFldkMsU0FBUyxxQkFBcUIsQ0FBQyxFQUFTLEVBQUUsRUFBUyxFQUFFLEVBQVMsRUFBRSxFQUFTO0lBQ3ZFLE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDdEMsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUN0QyxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsRUFBRSxFQUFFLFNBQVM7UUFDckMsT0FBTztZQUNMLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ2hCLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQ2hCLEdBQUcsRUFBRSxDQUFDO1lBQ04sR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDaEIsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDaEIsR0FBRyxFQUFFLENBQUM7WUFDTixHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDVCxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDVCxHQUFHLEVBQUUsQ0FBQztTQUNQLENBQUM7S0FDSDtTQUFNO1FBQ0wsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3hCLE1BQU0sR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN4QixNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDeEIsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3hCLE1BQU0sV0FBVyxHQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUMxQyxNQUFNLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLFdBQVcsQ0FBQztRQUNsRCxNQUFNLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxHQUFHLEdBQUcsQ0FBQyxHQUFHLFdBQVcsQ0FBQztRQUNsRCxPQUFPO1lBQ0wsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDN0IsR0FBRyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDN0IsR0FBRztZQUNILEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQzdCLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDLEdBQUcsR0FBRyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQzdCLEdBQUc7WUFDSCxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDVCxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDVCxHQUFHLEVBQUUsQ0FBQztTQUNQLENBQUM7S0FDSDtBQUNILENBQUM7QUFFRCxTQUFTLHFCQUFxQixDQUFDLEVBQVMsRUFBRSxFQUFTLEVBQUUsRUFBUyxFQUFFLEVBQVM7SUFDdkUsMkNBQTJDO0lBQzNDLE1BQU0sSUFBSSxHQUFHLHFCQUFxQixDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ25ELE9BQU87UUFDTCxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUc7UUFDOUMsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHO1FBQzlDLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRztRQUM5QyxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUc7UUFDOUMsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHO1FBQzlDLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRztRQUM5QyxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUc7UUFDOUMsR0FBRyxFQUFFLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHO1FBQzlDLEdBQUcsRUFBRSxJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRztLQUMvQyxDQUFDO0FBQ0osQ0FBQztBQUVELFNBQVMsS0FBSyxDQUFDLENBQXVCLEVBQUUsQ0FBdUI7SUFDN0QsT0FBTztRQUNMLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUc7UUFDbEQsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRztRQUNsRCxHQUFHLEVBQUUsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHO1FBQ2xELEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUc7UUFDbEQsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRztRQUNsRCxHQUFHLEVBQUUsQ0FBQyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLEdBQUcsR0FB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QyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUNuRjtLQUNGO0lBRUQsT0FBTztRQUNMLE1BQU07UUFDTixlQUFlO0tBQ2hCLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtCaXRNYXRyaXh9IGZyb20gXCIuLi9CaXRNYXRyaXhcIjtcbmltcG9ydCB7UG9pbnQsIFFSTG9jYXRpb259IGZyb20gXCIuLi9sb2NhdG9yXCI7XG5cbmludGVyZmFjZSBQZXJzcGVjdGl2ZVRyYW5zZm9ybSB7XG4gIGExMTogbnVtYmVyO1xuICBhMjE6IG51bWJlcjtcbiAgYTMxOiBudW1iZXI7XG4gIGExMjogbnVtYmVyO1xuICBhMjI6IG51bWJlcjtcbiAgYTMyOiBudW1iZXI7XG4gIGExMzogbnVtYmVyO1xuICBhMjM6IG51bWJlcjtcbiAgYTMzOiBudW1iZXI7XG59XG5cbmZ1bmN0aW9uIHNxdWFyZVRvUXVhZHJpbGF0ZXJhbChwMTogUG9pbnQsIHAyOiBQb2ludCwgcDM6IFBvaW50LCBwNDogUG9pbnQpOiBQZXJzcGVjdGl2ZVRyYW5zZm9ybSB7XG4gIGNvbnN0IGR4MyA9IHAxLnggLSBwMi54ICsgcDMueCAtIHA0Lng7XG4gIGNvbnN0IGR5MyA9IHAxLnkgLSBwMi55ICsgcDMueSAtIHA0Lnk7XG4gIGlmIChkeDMgPT09IDAgJiYgZHkzID09PSAwKSB7IC8vIEFmZmluZVxuICAgIHJldHVybiB7XG4gICAgICBhMTE6IHAyLnggLSBwMS54LFxuICAgICAgYTEyOiBwMi55IC0gcDEueSxcbiAgICAgIGExMzogMCxcbiAgICAgIGEyMTogcDMueCAtIHAyLngsXG4gICAgICBhMjI6IHAzLnkgLSBwMi55LFxuICAgICAgYTIzOiAwLFxuICAgICAgYTMxOiBwMS54LFxuICAgICAgYTMyOiBwMS55LFxuICAgICAgYTMzOiAxLFxuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgY29uc3QgZHgxID0gcDIueCAtIHAzLng7XG4gICAgY29uc3QgZHgyID0gcDQueCAtIHAzLng7XG4gICAgY29uc3QgZHkxID0gcDIueSAtIHAzLnk7XG4gICAgY29uc3QgZHkyID0gcDQueSAtIHAzLnk7XG4gICAgY29uc3QgZGVub21pbmF0b3IgPSBkeDEgKiBkeTIgLSBkeDIgKiBkeTE7XG4gICAgY29uc3QgYTEzID0gKGR4MyAqIGR5MiAtIGR4MiAqIGR5MykgLyBkZW5vbWluYXRvcjtcbiAgICBjb25zdCBhMjMgPSAoZHgxICogZHkzIC0gZHgzICogZHkxKSAvIGRlbm9taW5hdG9yO1xuICAgIHJldHVybiB7XG4gICAgICBhMTE6IHAyLnggLSBwMS54ICsgYTEzICogcDIueCxcbiAgICAgIGExMjogcDIueSAtIHAxLnkgKyBhMTMgKiBwMi55LFxuICAgICAgYTEzLFxuICAgICAgYTIxOiBwNC54IC0gcDEueCArIGEyMyAqIHA0LngsXG4gICAgICBhMjI6IHA0LnkgLSBwMS55ICsgYTIzICogcDQueSxcbiAgICAgIGEyMyxcbiAgICAgIGEzMTogcDEueCxcbiAgICAgIGEzMjogcDEueSxcbiAgICAgIGEzMzogMSxcbiAgICB9O1xuICB9XG59XG5cbmZ1bmN0aW9uIHF1YWRyaWxhdGVyYWxUb1NxdWFyZShwMTogUG9pbnQsIHAyOiBQb2ludCwgcDM6IFBvaW50LCBwNDogUG9pbnQpOiBQZXJzcGVjdGl2ZVRyYW5zZm9ybSB7XG4gIC8vIEhlcmUsIHRoZSBhZGpvaW50IHNlcnZlcyBhcyB0aGUgaW52ZXJzZTpcbiAgY29uc3Qgc1RvUSA9IHNxdWFyZVRvUXVhZHJpbGF0ZXJhbChwMSwgcDIsIHAzLCBwNCk7XG4gIHJldHVybiB7XG4gICAgYTExOiBzVG9RLmEyMiAqIHNUb1EuYTMzIC0gc1RvUS5hMjMgKiBzVG9RLmEzMixcbiAgICBhMTI6IHNUb1EuYTEzICogc1RvUS5hMzIgLSBzVG9RLmExMiAqIHNUb1EuYTMzLFxuICAgIGExMzogc1RvUS5hMTIgKiBzVG9RLmEyMyAtIHNUb1EuYTEzICogc1RvUS5hMjIsXG4gICAgYTIxOiBzVG9RLmEyMyAqIHNUb1EuYTMxIC0gc1RvUS5hMjEgKiBzVG9RLmEzMyxcbiAgICBhMjI6IHNUb1EuYTExICogc1RvUS5hMzMgLSBzVG9RLmExMyAqIHNUb1EuYTMxLFxuICAgIGEyMzogc1RvUS5hMTMgKiBzVG9RLmEyMSAtIHNUb1EuYTExICogc1RvUS5hMjMsXG4gICAgYTMxOiBzVG9RLmEyMSAqIHNUb1EuYTMyIC0gc1RvUS5hMjIgKiBzVG9RLmEzMSxcbiAgICBhMzI6IHNUb1EuYTEyICogc1RvUS5hMzEgLSBzVG9RLmExMSAqIHNUb1EuYTMyLFxuICAgIGEzMzogc1RvUS5hMTEgKiBzVG9RLmEyMiAtIHNUb1EuYTEyICogc1RvUS5hMjEsXG4gIH07XG59XG5cbmZ1bmN0aW9uIHRpbWVzKGE6IFBlcnNwZWN0aXZlVHJhbnNmb3JtLCBiOiBQZXJzcGVjdGl2ZVRyYW5zZm9ybSk6IFBlcnNwZWN0aXZlVHJhbnNmb3JtIHtcbiAgcmV0dXJuIHtcbiAgICBhMTE6IGEuYTExICogYi5hMTEgKyBhLmEyMSAqIGIuYTEyICsgYS5hMzEgKiBiLmExMyxcbiAgICBhMTI6IGEuYTEyICogYi5hMTEgKyBhLmEyMiAqIGIuYTEyICsgYS5hMzIgKiBiLmExMyxcbiAgICBhMTM6IGEuYTEzICogYi5hMTEgKyBhLmEyMyAqIGIuYTEyICsgYS5hMzMgKiBiLmExMyxcbiAgICBhMjE6IGEuYTExICogYi5hMjEgKyBhLmEyMSAqIGIuYTIyICsgYS5hMzEgKiBiLmEyMyxcbiAgICBhMjI6IGEuYTEyICogYi5hMjEgKyBhLmEyMiAqIGIuYTIyICsgYS5hMzIgKiBiLmEyMyxcbiAgICBhMjM6IGEuYTEzICogYi5hMjEgKyBhLmEyMyAqIGIuYTIyICsgYS5hMzMgKiBiLmEyMyxcbiAgICBhMzE6IGEuYTExICogYi5hMzEgKyBhLmEyMSAqIGIuYTMyICsgYS5hMzEgKiBiLmEzMyxcbiAgICBhMzI6IGEuYTEyICogYi5hMzEgKyBhLmEyMiAqIGIuYTMyICsgYS5hMzIgKiBiLmEzMyxcbiAgICBhMzM6IGEuYTEzICogYi5hMzEgKyBhLmEyMyAqIGIuYTMyICsgYS5hMzMgKiBiLmEzMyxcbiAgfTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGV4dHJhY3QoaW1hZ2U6IEJpdE1hdHJpeCwgbG9jYXRpb246IFFSTG9jYXRpb24pIHtcbiAgY29uc3QgcVRvUyA9IHF1YWRyaWxhdGVyYWxUb1NxdWFyZShcbiAgICB7eDogMy41LCB5OiAzLjV9LFxuICAgIHt4OiBsb2NhdGlvbi5kaW1lbnNpb24gLSAzLjUsIHk6IDMuNX0sXG4gICAge3g6IGxvY2F0aW9uLmRpbWVuc2lvbiAtIDYuNSwgeTogbG9jYXRpb24uZGltZW5zaW9uIC0gNi41fSxcbiAgICB7eDogMy41LCB5OiBsb2NhdGlvbi5kaW1lbnNpb24gLSAzLjV9LFxuICApO1xuICBjb25zdCBzVG9RID0gc3F1YXJlVG9RdWFkcmlsYXRlcmFsKGxvY2F0aW9uLnRvcExlZnQsIGxvY2F0aW9uLnRvcFJpZ2h0LCBsb2NhdGlvbi5hbGlnbm1lbnRQYXR0ZXJuLCBsb2NhdGlvbi5ib3R0b21MZWZ0KTtcbiAgY29uc3QgdHJhbnNmb3JtID0gdGltZXMoc1RvUSwgcVRvUyk7XG5cbiAgY29uc3QgbWF0cml4ID0gQml0TWF0cml4LmNyZWF0ZUVtcHR5KGxvY2F0aW9uLmRpbWVuc2lvbiwgbG9jYXRpb24uZGltZW5zaW9uKTtcbiAgY29uc3QgbWFwcGluZ0Z1bmN0aW9uID0gKHg6IG51bWJlciwgeTogbnVtYmVyKSA9PiB7XG4gICAgY29uc3QgZGVub21pbmF0b3IgPSB0cmFuc2Zvcm0uYTEzICogeCArIHRyYW5zZm9ybS5hMjMgKiB5ICsgdHJhbnNmb3JtLmEzMztcbiAgICByZXR1cm4ge1xuICAgICAgeDogKHRyYW5zZm9ybS5hMTEgKiB4ICsgdHJhbnNmb3JtLmEyMSAqIHkgKyB0cmFuc2Zvcm0uYTMxKSAvIGRlbm9taW5hdG9yLFxuICAgICAgeTogKHRyYW5zZm9ybS5hMTIgKiB4ICsgdHJhbnNmb3JtLmEyMiAqIHkgKyB0cmFuc2Zvcm0uYTMyKSAvIGRlbm9taW5hdG9yLFxuICAgIH07XG4gIH07XG5cbiAgZm9yIChsZXQgeSA9IDA7IHkgPCBsb2NhdGlvbi5kaW1lbnNpb247IHkrKykge1xuICAgIGZvciAobGV0IHggPSAwOyB4IDwgbG9jYXRpb24uZGltZW5zaW9uOyB4KyspIHtcbiAgICAgIGNvbnN0IHhWYWx1ZSA9IHggKyAwLjU7XG4gICAgICBjb25zdCB5VmFsdWUgPSB5ICsgMC41O1xuICAgICAgY29uc3Qgc291cmNlUGl4ZWwgPSBtYXBwaW5nRnVuY3Rpb24oeFZhbHVlLCB5VmFsdWUpO1xuICAgICAgbWF0cml4LnNldCh4LCB5LCBpbWFnZS5nZXQoTWF0aC5mbG9vcihzb3VyY2VQaXhlbC54KSwgTWF0aC5mbG9vcihzb3VyY2VQaXhlbC55KSkpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB7XG4gICAgbWF0cml4LFxuICAgIG1hcHBpbmdGdW5jdGlvbixcbiAgfTtcbn1cbiJdfQ==