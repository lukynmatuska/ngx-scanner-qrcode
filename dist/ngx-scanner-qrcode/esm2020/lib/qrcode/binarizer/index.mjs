import { BitMatrix } from "../BitMatrix";
const REGION_SIZE = 8;
const MIN_DYNAMIC_RANGE = 24;
function numBetween(value, min, max) {
    return value < min ? min : value > max ? max : value;
}
// Like BitMatrix but accepts arbitry Uint8 values
class Matrix {
    constructor(width, height) {
        this.width = width;
        this.data = new Uint8ClampedArray(width * height);
    }
    get(x, y) {
        return this.data[y * this.width + x];
    }
    set(x, y, value) {
        this.data[y * this.width + x] = value;
    }
}
export function binarize(data, width, height, returnInverted) {
    if (data.length !== width * height * 4) {
        throw new Error("Malformed data passed to binarizer.");
    }
    // Convert image to greyscale
    const greyscalePixels = new Matrix(width, height);
    for (let x = 0; x < width; x++) {
        for (let y = 0; y < height; y++) {
            const r = data[((y * width + x) * 4) + 0];
            const g = data[((y * width + x) * 4) + 1];
            const b = data[((y * width + x) * 4) + 2];
            greyscalePixels.set(x, y, 0.2126 * r + 0.7152 * g + 0.0722 * b);
        }
    }
    const horizontalRegionCount = Math.ceil(width / REGION_SIZE);
    const verticalRegionCount = Math.ceil(height / REGION_SIZE);
    const blackPoints = new Matrix(horizontalRegionCount, verticalRegionCount);
    for (let verticalRegion = 0; verticalRegion < verticalRegionCount; verticalRegion++) {
        for (let hortizontalRegion = 0; hortizontalRegion < horizontalRegionCount; hortizontalRegion++) {
            let sum = 0;
            let min = Infinity;
            let max = 0;
            for (let y = 0; y < REGION_SIZE; y++) {
                for (let x = 0; x < REGION_SIZE; x++) {
                    const pixelLumosity = greyscalePixels.get(hortizontalRegion * REGION_SIZE + x, verticalRegion * REGION_SIZE + y);
                    sum += pixelLumosity;
                    min = Math.min(min, pixelLumosity);
                    max = Math.max(max, pixelLumosity);
                }
            }
            let average = sum / (REGION_SIZE ** 2);
            if (max - min <= MIN_DYNAMIC_RANGE) {
                // If variation within the block is low, assume this is a block with only light or only
                // dark pixels. In that case we do not want to use the average, as it would divide this
                // low contrast area into black and white pixels, essentially creating data out of noise.
                //
                // Default the blackpoint for these blocks to be half the min - effectively white them out
                average = min / 2;
                if (verticalRegion > 0 && hortizontalRegion > 0) {
                    // Correct the "white background" assumption for blocks that have neighbors by comparing
                    // the pixels in this block to the previously calculated black points. This is based on
                    // the fact that dark barcode symbology is always surrounded by some amount of light
                    // background for which reasonable black point estimates were made. The bp estimated at
                    // the boundaries is used for the interior.
                    // The (min < bp) is arbitrary but works better than other heuristics that were tried.
                    const averageNeighborBlackPoint = (blackPoints.get(hortizontalRegion, verticalRegion - 1) +
                        (2 * blackPoints.get(hortizontalRegion - 1, verticalRegion)) +
                        blackPoints.get(hortizontalRegion - 1, verticalRegion - 1)) / 4;
                    if (min < averageNeighborBlackPoint) {
                        average = averageNeighborBlackPoint;
                    }
                }
            }
            blackPoints.set(hortizontalRegion, verticalRegion, average);
        }
    }
    const binarized = BitMatrix.createEmpty(width, height);
    let inverted = null;
    if (returnInverted) {
        inverted = BitMatrix.createEmpty(width, height);
    }
    for (let verticalRegion = 0; verticalRegion < verticalRegionCount; verticalRegion++) {
        for (let hortizontalRegion = 0; hortizontalRegion < horizontalRegionCount; hortizontalRegion++) {
            const left = numBetween(hortizontalRegion, 2, horizontalRegionCount - 3);
            const top = numBetween(verticalRegion, 2, verticalRegionCount - 3);
            let sum = 0;
            for (let xRegion = -2; xRegion <= 2; xRegion++) {
                for (let yRegion = -2; yRegion <= 2; yRegion++) {
                    sum += blackPoints.get(left + xRegion, top + yRegion);
                }
            }
            const threshold = sum / 25;
            for (let xRegion = 0; xRegion < REGION_SIZE; xRegion++) {
                for (let yRegion = 0; yRegion < REGION_SIZE; yRegion++) {
                    const x = hortizontalRegion * REGION_SIZE + xRegion;
                    const y = verticalRegion * REGION_SIZE + yRegion;
                    const lum = greyscalePixels.get(x, y);
                    binarized.set(x, y, lum <= threshold);
                    if (returnInverted) {
                        inverted.set(x, y, !(lum <= threshold));
                    }
                }
            }
        }
    }
    if (returnInverted) {
        return { binarized, inverted };
    }
    return { binarized };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc2Nhbm5lci1xcmNvZGUvc3JjL2xpYi9xcmNvZGUvYmluYXJpemVyL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxTQUFTLEVBQUMsTUFBTSxjQUFjLENBQUM7QUFFdkMsTUFBTSxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBQ3RCLE1BQU0saUJBQWlCLEdBQUcsRUFBRSxDQUFDO0FBRTdCLFNBQVMsVUFBVSxDQUFDLEtBQWEsRUFBRSxHQUFXLEVBQUUsR0FBVztJQUN6RCxPQUFPLEtBQUssR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7QUFDdkQsQ0FBQztBQUVELGtEQUFrRDtBQUNsRCxNQUFNLE1BQU07SUFHVixZQUFZLEtBQWEsRUFBRSxNQUFjO1FBQ3ZDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxpQkFBaUIsQ0FBQyxLQUFLLEdBQUcsTUFBTSxDQUFDLENBQUM7SUFDcEQsQ0FBQztJQUNNLEdBQUcsQ0FBQyxDQUFTLEVBQUUsQ0FBUztRQUM3QixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUNNLEdBQUcsQ0FBQyxDQUFTLEVBQUUsQ0FBUyxFQUFFLEtBQWE7UUFDNUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUM7SUFDeEMsQ0FBQztDQUNGO0FBRUQsTUFBTSxVQUFVLFFBQVEsQ0FBQyxJQUF1QixF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O29CQUN0QyxJQUFJLGNBQWMsRUFBRTt3QkFDbEIsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksU0FBUyxDQUFDLENBQUMsQ0FBQztxQkFDekM7aUJBQ0Y7YUFDRjtTQUNGO0tBQ0Y7SUFDRCxJQUFJLGNBQWMsRUFBRTtRQUNsQixPQUFPLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxDQUFDO0tBQ2hDO0lBQ0QsT0FBTyxFQUFFLFNBQVMsRUFBRSxDQUFDO0FBQ3ZCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0JpdE1hdHJpeH0gZnJvbSBcIi4uL0JpdE1hdHJpeFwiO1xuXG5jb25zdCBSRUdJT05fU0laRSA9IDg7XG5jb25zdCBNSU5fRFlOQU1JQ19SQU5HRSA9IDI0O1xuXG5mdW5jdGlvbiBudW1CZXR3ZWVuKHZhbHVlOiBudW1iZXIsIG1pbjogbnVtYmVyLCBtYXg6IG51bWJlcik6IG51bWJlciB7XG4gIHJldHVybiB2YWx1ZSA8IG1pbiA/IG1pbiA6IHZhbHVlID4gbWF4ID8gbWF4IDogdmFsdWU7XG59XG5cbi8vIExpa2UgQml0TWF0cml4IGJ1dCBhY2NlcHRzIGFyYml0cnkgVWludDggdmFsdWVzXG5jbGFzcyBNYXRyaXgge1xuICBwcml2YXRlIGRhdGE6IFVpbnQ4Q2xhbXBlZEFycmF5O1xuICBwcml2YXRlIHdpZHRoOiBudW1iZXI7XG4gIGNvbnN0cnVjdG9yKHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyKSB7XG4gICAgdGhpcy53aWR0aCA9IHdpZHRoO1xuICAgIHRoaXMuZGF0YSA9IG5ldyBVaW50OENsYW1wZWRBcnJheSh3aWR0aCAqIGhlaWdodCk7XG4gIH1cbiAgcHVibGljIGdldCh4OiBudW1iZXIsIHk6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLmRhdGFbeSAqIHRoaXMud2lkdGggKyB4XTtcbiAgfVxuICBwdWJsaWMgc2V0KHg6IG51bWJlciwgeTogbnVtYmVyLCB2YWx1ZTogbnVtYmVyKSB7XG4gICAgdGhpcy5kYXRhW3kgKiB0aGlzLndpZHRoICsgeF0gPSB2YWx1ZTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gYmluYXJpemUoZGF0YTogVWludDhDbGFtcGVkQXJyYXksIHdpZHRoOiBudW1iZXIsIGhlaWdodDogbnVtYmVyLCByZXR1cm5JbnZlcnRlZDogYm9vbGVhbikge1xuICBpZiAoZGF0YS5sZW5ndGggIT09IHdpZHRoICogaGVpZ2h0ICogNCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIk1hbGZvcm1lZCBkYXRhIHBhc3NlZCB0byBiaW5hcml6ZXIuXCIpO1xuICB9XG4gIC8vIENvbnZlcnQgaW1hZ2UgdG8gZ3JleXNjYWxlXG4gIGNvbnN0IGdyZXlzY2FsZVBpeGVscyA9IG5ldyBNYXRyaXgod2lkdGgsIGhlaWdodCk7XG4gIGZvciAobGV0IHggPSAwOyB4IDwgd2lkdGg7IHgrKykge1xuICAgIGZvciAobGV0IHkgPSAwOyB5IDwgaGVpZ2h0OyB5KyspIHtcbiAgICAgIGNvbnN0IHIgPSBkYXRhWygoeSAqIHdpZHRoICsgeCkgKiA0KSArIDBdO1xuICAgICAgY29uc3QgZyA9IGRhdGFbKCh5ICogd2lkdGggKyB4KSAqIDQpICsgMV07XG4gICAgICBjb25zdCBiID0gZGF0YVsoKHkgKiB3aWR0aCArIHgpICogNCkgKyAyXTtcbiAgICAgIGdyZXlzY2FsZVBpeGVscy5zZXQoeCwgeSwgMC4yMTI2ICogciArIDAuNzE1MiAqIGcgKyAwLjA3MjIgKiBiKTtcbiAgICB9XG4gIH1cbiAgY29uc3QgaG9yaXpvbnRhbFJlZ2lvbkNvdW50ID0gTWF0aC5jZWlsKHdpZHRoIC8gUkVHSU9OX1NJWkUpO1xuICBjb25zdCB2ZXJ0aWNhbFJlZ2lvbkNvdW50ID0gTWF0aC5jZWlsKGhlaWdodCAvIFJFR0lPTl9TSVpFKTtcblxuICBjb25zdCBibGFja1BvaW50cyA9IG5ldyBNYXRyaXgoaG9yaXpvbnRhbFJlZ2lvbkNvdW50LCB2ZXJ0aWNhbFJlZ2lvbkNvdW50KTtcbiAgZm9yIChsZXQgdmVydGljYWxSZWdpb24gPSAwOyB2ZXJ0aWNhbFJlZ2lvbiA8IHZlcnRpY2FsUmVnaW9uQ291bnQ7IHZlcnRpY2FsUmVnaW9uKyspIHtcbiAgICBmb3IgKGxldCBob3J0aXpvbnRhbFJlZ2lvbiA9IDA7IGhvcnRpem9udGFsUmVnaW9uIDwgaG9yaXpvbnRhbFJlZ2lvbkNvdW50OyBob3J0aXpvbnRhbFJlZ2lvbisrKSB7XG4gICAgICBsZXQgc3VtID0gMDtcbiAgICAgIGxldCBtaW4gPSBJbmZpbml0eTtcbiAgICAgIGxldCBtYXggPSAwO1xuICAgICAgZm9yIChsZXQgeSA9IDA7IHkgPCBSRUdJT05fU0laRTsgeSsrKSB7XG4gICAgICAgIGZvciAobGV0IHggPSAwOyB4IDwgUkVHSU9OX1NJWkU7IHgrKykge1xuICAgICAgICAgIGNvbnN0IHBpeGVsTHVtb3NpdHkgPVxuICAgICAgICAgICAgZ3JleXNjYWxlUGl4ZWxzLmdldChob3J0aXpvbnRhbFJlZ2lvbiAqIFJFR0lPTl9TSVpFICsgeCwgdmVydGljYWxSZWdpb24gKiBSRUdJT05fU0laRSArIHkpO1xuICAgICAgICAgIHN1bSArPSBwaXhlbEx1bW9zaXR5O1xuICAgICAgICAgIG1pbiA9IE1hdGgubWluKG1pbiwgcGl4ZWxMdW1vc2l0eSk7XG4gICAgICAgICAgbWF4ID0gTWF0aC5tYXgobWF4LCBwaXhlbEx1bW9zaXR5KTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBsZXQgYXZlcmFnZSA9IHN1bSAvIChSRUdJT05fU0laRSAqKiAyKTtcbiAgICAgIGlmIChtYXggLSBtaW4gPD0gTUlOX0RZTkFNSUNfUkFOR0UpIHtcbiAgICAgICAgLy8gSWYgdmFyaWF0aW9uIHdpdGhpbiB0aGUgYmxvY2sgaXMgbG93LCBhc3N1bWUgdGhpcyBpcyBhIGJsb2NrIHdpdGggb25seSBsaWdodCBvciBvbmx5XG4gICAgICAgIC8vIGRhcmsgcGl4ZWxzLiBJbiB0aGF0IGNhc2Ugd2UgZG8gbm90IHdhbnQgdG8gdXNlIHRoZSBhdmVyYWdlLCBhcyBpdCB3b3VsZCBkaXZpZGUgdGhpc1xuICAgICAgICAvLyBsb3cgY29udHJhc3QgYXJlYSBpbnRvIGJsYWNrIGFuZCB3aGl0ZSBwaXhlbHMsIGVzc2VudGlhbGx5IGNyZWF0aW5nIGRhdGEgb3V0IG9mIG5vaXNlLlxuICAgICAgICAvL1xuICAgICAgICAvLyBEZWZhdWx0IHRoZSBibGFja3BvaW50IGZvciB0aGVzZSBibG9ja3MgdG8gYmUgaGFsZiB0aGUgbWluIC0gZWZmZWN0aXZlbHkgd2hpdGUgdGhlbSBvdXRcbiAgICAgICAgYXZlcmFnZSA9IG1pbiAvIDI7XG5cbiAgICAgICAgaWYgKHZlcnRpY2FsUmVnaW9uID4gMCAmJiBob3J0aXpvbnRhbFJlZ2lvbiA+IDApIHtcbiAgICAgICAgICAvLyBDb3JyZWN0IHRoZSBcIndoaXRlIGJhY2tncm91bmRcIiBhc3N1bXB0aW9uIGZvciBibG9ja3MgdGhhdCBoYXZlIG5laWdoYm9ycyBieSBjb21wYXJpbmdcbiAgICAgICAgICAvLyB0aGUgcGl4ZWxzIGluIHRoaXMgYmxvY2sgdG8gdGhlIHByZXZpb3VzbHkgY2FsY3VsYXRlZCBibGFjayBwb2ludHMuIFRoaXMgaXMgYmFzZWQgb25cbiAgICAgICAgICAvLyB0aGUgZmFjdCB0aGF0IGRhcmsgYmFyY29kZSBzeW1ib2xvZ3kgaXMgYWx3YXlzIHN1cnJvdW5kZWQgYnkgc29tZSBhbW91bnQgb2YgbGlnaHRcbiAgICAgICAgICAvLyBiYWNrZ3JvdW5kIGZvciB3aGljaCByZWFzb25hYmxlIGJsYWNrIHBvaW50IGVzdGltYXRlcyB3ZXJlIG1hZGUuIFRoZSBicCBlc3RpbWF0ZWQgYXRcbiAgICAgICAgICAvLyB0aGUgYm91bmRhcmllcyBpcyB1c2VkIGZvciB0aGUgaW50ZXJpb3IuXG5cbiAgICAgICAgICAvLyBUaGUgKG1pbiA8IGJwKSBpcyBhcmJpdHJhcnkgYnV0IHdvcmtzIGJldHRlciB0aGFuIG90aGVyIGhldXJpc3RpY3MgdGhhdCB3ZXJlIHRyaWVkLlxuICAgICAgICAgIGNvbnN0IGF2ZXJhZ2VOZWlnaGJvckJsYWNrUG9pbnQgPSAoXG4gICAgICAgICAgICBibGFja1BvaW50cy5nZXQoaG9ydGl6b250YWxSZWdpb24sIHZlcnRpY2FsUmVnaW9uIC0gMSkgK1xuICAgICAgICAgICAgKDIgKiBibGFja1BvaW50cy5nZXQoaG9ydGl6b250YWxSZWdpb24gLSAxLCB2ZXJ0aWNhbFJlZ2lvbikpICtcbiAgICAgICAgICAgIGJsYWNrUG9pbnRzLmdldChob3J0aXpvbnRhbFJlZ2lvbiAtIDEsIHZlcnRpY2FsUmVnaW9uIC0gMSlcbiAgICAgICAgICApIC8gNDtcbiAgICAgICAgICBpZiAobWluIDwgYXZlcmFnZU5laWdoYm9yQmxhY2tQb2ludCkge1xuICAgICAgICAgICAgYXZlcmFnZSA9IGF2ZXJhZ2VOZWlnaGJvckJsYWNrUG9pbnQ7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBibGFja1BvaW50cy5zZXQoaG9ydGl6b250YWxSZWdpb24sIHZlcnRpY2FsUmVnaW9uLCBhdmVyYWdlKTtcbiAgICB9XG4gIH1cblxuICBjb25zdCBiaW5hcml6ZWQgPSBCaXRNYXRyaXguY3JlYXRlRW1wdHkod2lkdGgsIGhlaWdodCk7XG4gIGxldCBpbnZlcnRlZDogQml0TWF0cml4ID0gbnVsbDtcbiAgaWYgKHJldHVybkludmVydGVkKSB7XG4gICAgaW52ZXJ0ZWQgPSBCaXRNYXRyaXguY3JlYXRlRW1wdHkod2lkdGgsIGhlaWdodCk7XG4gIH1cbiAgZm9yIChsZXQgdmVydGljYWxSZWdpb24gPSAwOyB2ZXJ0aWNhbFJlZ2lvbiA8IHZlcnRpY2FsUmVnaW9uQ291bnQ7IHZlcnRpY2FsUmVnaW9uKyspIHtcbiAgICBmb3IgKGxldCBob3J0aXpvbnRhbFJlZ2lvbiA9IDA7IGhvcnRpem9udGFsUmVnaW9uIDwgaG9yaXpvbnRhbFJlZ2lvbkNvdW50OyBob3J0aXpvbnRhbFJlZ2lvbisrKSB7XG4gICAgICBjb25zdCBsZWZ0ID0gbnVtQmV0d2Vlbihob3J0aXpvbnRhbFJlZ2lvbiwgMiwgaG9yaXpvbnRhbFJlZ2lvbkNvdW50IC0gMyk7XG4gICAgICBjb25zdCB0b3AgPSBudW1CZXR3ZWVuKHZlcnRpY2FsUmVnaW9uLCAyLCB2ZXJ0aWNhbFJlZ2lvbkNvdW50IC0gMyk7XG4gICAgICBsZXQgc3VtID0gMDtcbiAgICAgIGZvciAobGV0IHhSZWdpb24gPSAtMjsgeFJlZ2lvbiA8PSAyOyB4UmVnaW9uKyspIHtcbiAgICAgICAgZm9yIChsZXQgeVJlZ2lvbiA9IC0yOyB5UmVnaW9uIDw9IDI7IHlSZWdpb24rKykge1xuICAgICAgICAgIHN1bSArPSBibGFja1BvaW50cy5nZXQobGVmdCArIHhSZWdpb24sIHRvcCArIHlSZWdpb24pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBjb25zdCB0aHJlc2hvbGQgPSBzdW0gLyAyNTtcbiAgICAgIGZvciAobGV0IHhSZWdpb24gPSAwOyB4UmVnaW9uIDwgUkVHSU9OX1NJWkU7IHhSZWdpb24rKykge1xuICAgICAgICBmb3IgKGxldCB5UmVnaW9uID0gMDsgeVJlZ2lvbiA8IFJFR0lPTl9TSVpFOyB5UmVnaW9uKyspIHtcbiAgICAgICAgICBjb25zdCB4ID0gaG9ydGl6b250YWxSZWdpb24gKiBSRUdJT05fU0laRSArIHhSZWdpb247XG4gICAgICAgICAgY29uc3QgeSA9IHZlcnRpY2FsUmVnaW9uICogUkVHSU9OX1NJWkUgKyB5UmVnaW9uO1xuICAgICAgICAgIGNvbnN0IGx1bSA9IGdyZXlzY2FsZVBpeGVscy5nZXQoeCwgeSk7XG4gICAgICAgICAgYmluYXJpemVkLnNldCh4LCB5LCBsdW0gPD0gdGhyZXNob2xkKTtcbiAgICAgICAgICBpZiAocmV0dXJuSW52ZXJ0ZWQpIHtcbiAgICAgICAgICAgIGludmVydGVkLnNldCh4LCB5LCAhKGx1bSA8PSB0aHJlc2hvbGQpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgaWYgKHJldHVybkludmVydGVkKSB7XG4gICAgcmV0dXJuIHsgYmluYXJpemVkLCBpbnZlcnRlZCB9O1xuICB9XG4gIHJldHVybiB7IGJpbmFyaXplZCB9O1xufVxuIl19